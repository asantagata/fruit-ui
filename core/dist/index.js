let e=0;const t={};const n=new Set;function i(){Array.from(n).forEach(e=>t[e]?.rerender());n.clear()}function s(e){const t=n.size===0;n.add(e);if(t)queueMicrotask(i)}function l(e){return{rerender(){},producer(){},element:null,state:{},setState:{},bindings:{},memo:typeof e.memo==="object"?N(e.memo):e.memo}}function o(e,t){this.element=e;this.producer=t;this.rerender=m.bind(this);this.setState=new Proxy({},{get:(e,n,i)=>e=>{this.state[n]=e;s(t.componentId)}})}function r(e,t,n=null){if(e.cloneFrom){const t=e.cloneFrom.cloneNode(true);if(this&&!this.element){o.call(this,t,n)}return t}else if(e.HTML){const t=document.createElement("div");t.innerHTML=e.HTML;return t.firstChild}const{tag:i,class:s,style:l,on:r,componentId:c,children:a,cloneFrom:f,dataset:h,key:u,binding:m,innerHTML:p,xmlns:g,...y}=e;const b=e.xmlns?document.createElementNS(e.xmlns,e.tag):document.createElement(e.tag||"div");if(e.class){switch(typeof e.class){case"string":b.className=e.class;break;case"object":if(Array.isArray(e)){b.className=e.class.join(" ")}else{b.className=Object.keys(e.class).filter(t=>e.class[t]).join(" ")}}}if(e.style){for(const t in e.style){b.style.setProperty(t,e.style[t])}}if(e.on){const{mount:n,...i}=e.on;for(const e in i){if(!i[e])continue;b.addEventListener(e,t=>i[e].call({...this??{},target:b},t))}if(n){t.push(()=>n.call({...this??{},target:b}))}}for(const t in y){if(!e[t])continue;b.setAttribute(t,e[t])}if(e.dataset){for(const t in e.dataset){b.dataset[t]=e.dataset[t]}}if(e.componentId){b.dataset.componentId=e.componentId}if(e.key){b.dataset.key=e.key}if(e.binding){b.dataset.binding=e.binding}if(this&&!this.element){o.call(this,b,n)}if(e.innerHTML){b.innerHTML=e.innerHTML}else if(e.children!==undefined){if(Array.isArray(e.children)){b.replaceChildren(...e.children.map(e=>d.call(this,e,t)));for(let t=0;t<e.children.length;t++){const n=e.children[t];if(n.binding&&this){j.call(this,n.binding,b.childNodes[t])}}}else{b.replaceChildren(d.call(this,e.children,t));if(e.children.binding&&this){j.call(this,e.children.binding,b.childNodes[0])}}}return b}function c(t,n){const i=l(n);const s=t.bind(i);s.this=i;s.componentId=`component-${e++}`;return s}function a(e){return!!e.render}function d(e,t){if(typeof e==="object"){if(a(e)){return f(e,t)}else{return r.call(this,e,t)}}else{return e.toString()}}function f(e,n){const i=c(e.render,e);t[i.componentId]=i.this;i.this.state=e.state?e.state.call(i.this):{};const s=i();return r.call(i.this,h(s,i.componentId,e.key,e.binding),n,i)}function h(e,t,n,i){return{...e,componentId:t,key:n??e.key,binding:i??e.binding}}function u(e){const t=[];e(t);t.forEach(e=>e())}function m(){u(e=>{const t=this.producer();b.call(this,this.element,h(t,this.producer.componentId),e)})}function p(e){const n=this.producer();const i=y(n,e);const s=g(this.element,e);if(i&&s){u(e=>{if(a(i)){if("componentId"in s.dataset)M(s,i,e);else s.replaceWith(f(i,e))}else{if("componentId"in s.dataset)delete t[s.dataset.componentId];b.call(this,s,i,e)}})}}function g(e,t,n=true){if(e.dataset.binding===t&&!n){return e}else if(!n&&"componentId"in e.dataset){return undefined}return Array.from(e.children).find(e=>!!g(e,t,false))}function y(e,t,n=true){if(e.binding===t&&!n){return e}if(e.children){if(Array.isArray(e.children)){return e.children.find(e=>y(e,t,false))}else{return y(e.children,t,false)}}return undefined}function b(e,t,n){if(typeof t!=="object"){return e.replaceWith(t.toString())}if(t.cloneFrom&&!e.isEqualNode(t.cloneFrom)){return e.replaceWith(t.cloneFrom.cloneNode(true))}else if(t.HTML){const n=document.createElement("div");n.innerHTML=t.HTML;return e.replaceWith(n.firstChild)}if((t.tag?.toUpperCase()||"DIV")!==e.tagName){return e.replaceWith(d.call(this,t,n))}if(t.class){if(typeof t.class==="string"){e.className=t.class}else if(Array.isArray(t)){e.className=t.class.join(" ")}else{for(const n in t.class){if(t.class[n]){e.classList.add(n)}else{e.classList.remove(n)}}}}if(t.style){for(const n in t.style){e.style.setProperty(n,t.style[n])}}if(t.dataset){for(let n in t.dataset){e.dataset[n]=t.dataset[n]}}const{tag:i,class:s,style:l,on:o,componentId:r,children:c,cloneFrom:a,dataset:f,key:h,binding:u,innerHTML:m,xmlns:p,...g}=t;for(const n in g){e.setAttribute(n,t[n])}if(t.innerHTML){e.innerHTML=t.innerHTML}else if(t.children===undefined||t.children.length===0){e.innerHTML=""}else{A.call(this,e,t,n)}}function I(e,t){if(typeof e!==typeof t)return false;if(typeof e==="function")return true;if(typeof e==="object"&&e!==null){if(typeof e[Symbol.iterator]==="function"){if(e.length===t.length&&e.size===t.size){const n=e[Symbol.iterator](),i=t[Symbol.iterator]();while(true){const e=n.next(),t=i.next();if(e.done===t.done){if(!I(e.value,t.value))return false;if(e.done)return true}else return false}}else return false}else{const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return false;return i.every(n=>n in e&&I(e[n],t[n]))}}else return e===t}function N(e){if(typeof e==="object"){if(e===null)return null;if(Array.isArray(e))return e.map(N);if(e instanceof Set)return new Set([...e].map(N));if(e instanceof Map)return new Map(e.entries().map(([e,t])=>[N(e),N(t)]));return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,N(t)]))}else return e}function k(e){if(e.memo&&this.memo){if(typeof e.memo==="function")return!!e.memo.call(this);const t=I(e.memo,this.memo);this.memo=N(e.memo);return t}else return false}function M(e,n,i){const s=t[e.dataset.componentId];if(k.call(s,n)){return}s.producer=n.render.bind(s);b.call(s,e,s.producer(),i)}function T(e,n,i){const s=t[n];if(k.call(s,e)){return s.element}s.producer=e.render.bind(s);const l=s.producer();const o=r.call(s,h(l,n,e.key,e.binding),i,s.producer);s.element=o;return o}function A(e,n,i){const s=Array.from(e.children);const l=Array.isArray(n.children)?n.children:[n.children];const o=l.filter(e=>typeof e==="object");if(s.length>0&&o.length>0&&s.every(e=>"key"in e.dataset)&&o.every(e=>"key"in e)){const n={};for(let e=0;e<s.length;e++){n[s[e].dataset.key]=e}const l={};for(let e=0;e<o.length;e++){l[o[e].key]=e}const r=o.map(e=>n[e.key]??-1);const c=L(r.filter(e=>e>-1));for(let e=0;e<c.length;e++){const n=c[e];const r=s[n];const d=o[l[r.dataset.key]];if(a(d)){if("componentId"in r.dataset)M(r,d,i);else r.replaceWith(f(d,i))}else{if("componentId"in r.dataset)delete t[r.dataset.componentId];b.call(this,r,d,i)}}const h=new Set(c);const u={};for(let e=s.length-1;e>=0;e--){if(!h.has(e)){const n=s[e];if("componentId"in n.dataset){if(n.dataset.key in l){u[n.dataset.key]=n.dataset.componentId}else{delete t[n.dataset.componentId]}}if("binding"in n.dataset)delete this.bindings[n.dataset.binding];n.remove()}}for(let t=0;t<o.length;t++){const n=o[t],s=e.children[t];if(!s){const t=u[n.key];if(t){e.appendChild(T(n,t,i))}else{e.appendChild(d.call(this,n,i))}}else{if(s.dataset.key!==n.key){const t=u[n.key];if(t){e.insertBefore(T(n,t,i),s)}else{e.insertBefore(d.call(this,n,i),s)}}}}}else if(o.length>0&&s.length>0){for(let e=0;e<Math.min(s.length,o.length);e++){let n=s[e],l=o[e];if("binding"in n.dataset&&n.dataset.binding!==l.binding)delete this.bindings[n.dataset.binding];if(a(l)){if("componentId"in n.dataset)M(n,l,i);else n.replaceWith(f(l,i))}else{if("componentId"in n.dataset)delete t[n.dataset.componentId];b.call(this,n,l,i)}}if(s.length<o.length){for(let t=s.length;t<o.length;t++){let n=o[t];const s=d.call(this,n,i);e.appendChild(s)}}else if(s.length>o.length){for(let e=s.length-1;e>=o.length;e--){let n=s[e];if("componentId"in n.dataset)delete t[n.dataset.componentId];if("binding"in n.dataset)delete this.bindings[n.dataset.binding];n.remove()}}}else if(o.length===0&&s.length>0){for(let e=s.length-1;e>=0;e--){let n=s[e];if("componentId"in n.dataset)delete t[n.dataset.componentId];if("binding"in n.dataset)delete this.bindings[n.dataset.binding];n.remove()}}else if(o.length>0&&s.length===0){for(let t=0;t<o.length;t++){let n=o[t];const s=d.call(this,n,i);e.appendChild(s)}}for(let t=0;t<o.length;t++){const n=o[t];if(n.binding){j.call(this,n.binding,e.children[t])}}for(let t=0;t<l.length;t++){if(t>=e.childNodes.length){e.appendChild(document.createTextNode(l[t]))}else{if(e.childNodes[t].nodeType===Node.TEXT_NODE){if(typeof l[t]!=="object"){e.childNodes[t].textContent=l[t]}else{while(e.childNodes[t].nodeType!==Node.ELEMENT_NODE){e.childNodes[t].remove()}}}else{if(typeof l[t]!=="object"){e.insertBefore(document.createTextNode(l[t]),e.childNodes[t])}}}}while(e.childNodes.length>l.length){e.lastChild.remove()}}function L(e){let t=e.length;let n=new Array(t).fill(0);let i=new Array(t+1).fill(0);i[0]=-1;let s=0;for(let l=0;l<t;l++){let t=1,o=s+1;while(t<o){let n=t+(o-t>>1);if(e[i[n]]>=e[l])o=n;else t=n+1}let r=t;n[l]=i[r-1];i[r]=l;if(r>s){s=r}}let l=new Array(s);let o=i[s];for(let t=s-1;t>=0;t--){l[t]=e[o];o=n[o]}return l}function j(e,t){this.bindings[e]={element:t,rerender:()=>p.call(this,e)}}function E(e,t=false){const n=[];let i=d(e,n);if(typeof i==="string")i=document.createTextNode(i);return t?{element:i,onMounts:n}:i}function v(e,t){const{element:n,onMounts:i}=E(t,true);e.replaceWith(n);C(i)}function H(e,t){const{element:n,onMounts:i}=E(t,true);e.appendChild(n);C(i)}function w(e,t,n){const{element:i,onMounts:s}=E(n,true);e.insertBefore(i,t);C(s)}function C(e){e.forEach(e=>e())}export{E as create,v as replaceWith,H as appendChild,w as insertBefore,C as handleOnMounts};