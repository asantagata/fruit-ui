let e=0;const t={};const n=new Set;function i(){Array.from(n).forEach(e=>t[e]?.rerender());n.clear()}function o(e){const t=n.size===0;n.add(e);if(t)queueMicrotask(i)}function s(e){return{rerender(){},producer(){},element:null,state:{},setState:{},bindings:{},memo:"memo"in e?k(e.memo()):false}}function l(e,t){this.element=e;if(t===null)return;this.producer=t;this.rerender=m.bind(this);this.setState=new Proxy({},{get:(e,n,i)=>e=>{this.state[n]=e;o(t.componentId)}});this.bindings=new Proxy({},{get:(e,t,n)=>({element:y(this.element,t),rerender:()=>p.call(this,t)})})}function r(e,t,n=null){if("cloneFrom"in e){const t=e.cloneFrom.cloneNode(true);if(e.key!==undefined){t.dataset.key=e.key}if(e.binding!==undefined){t.dataset.binding=e.binding}if(e.componentId!==undefined){t.dataset.componentId=e.componentId;l.call(this,t,n)}return t}else if("HTML"in e){const t=document.createElement("div");t.innerHTML=e.HTML;const i=t.firstChild;if(e.key!==undefined){i.dataset.key=e.key}if(e.binding!==undefined){i.dataset.binding=e.binding}if(e.componentId!==undefined){i.dataset.componentId=e.componentId;l.call(this,i,n)}return i}const{tag:i,class:o,style:s,on:r,componentId:c,children:d,cloneFrom:f,dataset:u,key:h,binding:m,innerHTML:p,xmlns:y,...g}=e;const b=e.xmlns?document.createElementNS(e.xmlns,e.tag):document.createElement(e.tag||"div");if("class"in e){switch(typeof e.class){case"string":b.className=e.class;break;case"object":if(Array.isArray(e)){b.className=e.class.join(" ")}else{b.className=Object.keys(e.class).filter(t=>e.class[t]).join(" ")}}}if("style"in e){for(const t in e.style){b.style.setProperty(t,e.style[t])}}if("on"in e){const{mount:n,...i}=e.on;for(const e in i){if(!i[e])continue;b.addEventListener(e,t=>i[e].call({...this??{},target:b},t))}if(n){t.push(()=>n.call({...this??{},target:b}))}}for(const t in g){if(e[t]===undefined)b.removeAttribute(t);else b.setAttribute(t,e[t])}if("dataset"in e){for(const t in e.dataset){b.dataset[t]=e.dataset[t]}}if(e.key!==undefined){b.dataset.key=e.key}if(e.binding!==undefined){b.dataset.binding=e.binding}if(e.componentId!==undefined){b.dataset.componentId=e.componentId;l.call(this,b,n)}if("innerHTML"in e){b.innerHTML=e.innerHTML}else if("children"in e){if(Array.isArray(e.children)){b.replaceChildren(...e.children.map(e=>a.call(this,e,t)))}else{b.replaceChildren(a.call(this,e.children,t))}}return b}function c(t,n){const i=s(n);const o=t.bind(i);o.this=i;o.componentId=`component-${e++}`;return o}function d(e){return!!e.render}function a(e,t){if(typeof e==="object"){if(d(e)){return f(e,t)}else{return r.call(this,e,t)}}else{return e.toString()}}function f(e,n){const i=c(e.render,e);t[i.componentId]=i.this;i.this.state=typeof e.state==="function"?e.state.call(i.this):e.state??{};const o=i();return r.call(i.this,u(o,i.componentId,e.key,e.binding),n,i)}function u(e,t,n,i){return{...e,componentId:t,key:n??e.key,binding:i??e.binding}}function h(e){const t=[];e(t);t.forEach(e=>e())}function m(){h(e=>{const t=this.producer();b.call(this,this.element,u(t,this.element.dataset.componentId,this.element.dataset.key,this.element.dataset.binding),e)})}function p(e){const n=this.producer();const i=g(n,e);const o=y(this.element,e);if(i&&o){h(e=>{if(d(i)){if("componentId"in o.dataset)N(o,i,e);else o.replaceWith(f(i,e))}else{if("componentId"in o.dataset)delete t[o.dataset.componentId];b.call(this,o,i,e)}})}}function y(e,t,n=true){if(e.dataset.binding===t&&!n){return e}else if(!n&&"componentId"in e.dataset){return undefined}for(const n of e.children){const e=y(n,t,false);if(e)return e}return undefined}function g(e,t,n=true){if(e.binding===t&&!n){return e}if(e.children){if(Array.isArray(e.children)){for(const n of e.children){const e=g(n,t,false);if(e)return e}}else{return g(e.children,t,false)}}return undefined}function b(e,t,n){if(typeof t!=="object"){e.replaceWith(t.toString())}if("cloneFrom"in t&&!e.isEqualNode(t.cloneFrom)){const n=t.cloneFrom.cloneNode(true);if(t.key!==undefined){n.dataset.key=t.key}if(t.binding!==undefined){n.dataset.binding=t.binding}if(t.componentId!==undefined){n.dataset.componentId=t.componentId;this.element=n}return e.replaceWith(n)}else if("HTML"in t){const n=document.createElement("div");n.innerHTML=t.HTML;const i=n.firstChild;if(t.key!==undefined){i.dataset.key=t.key}if(t.binding!==undefined){i.dataset.binding=t.binding}if(t.componentId!==undefined){i.dataset.componentId=t.componentId;this.element=i}return e.replaceWith(i)}if((t.tag?.toUpperCase()||"DIV")!==e.tagName.toUpperCase()){const i=a.call(this,t,n);if("componentId"in t)this.element=i;return e.replaceWith(i)}if("class"in t){if(typeof t.class==="string"){e.className=t.class}else if(Array.isArray(t)){e.className=t.class.join(" ")}else{for(const n in t.class){if(t.class[n]){e.classList.add(n)}else{e.classList.remove(n)}}}}if("style"in t){for(const n in t.style){e.style.setProperty(n,t.style[n])}}if("dataset"in t){for(let n in t.dataset){e.dataset[n]=t.dataset[n]}}const{tag:i,class:o,style:s,on:l,componentId:r,children:c,cloneFrom:d,dataset:f,key:u,binding:h,innerHTML:m,xmlns:p,...y}=t;for(const n in y){if(t[n]===undefined)e.removeAttribute(n);else e.setAttribute(n,t[n])}if("innerHTML"in t){e.innerHTML=t.innerHTML}else if(t.children===undefined||t.children.length===0){e.innerHTML=""}else{A.call(this,e,t,n)}}function I(e,t){if(typeof e!==typeof t)return false;if(typeof e==="function")return true;if(typeof e==="object"&&e!==null&&t!==null){if(typeof e[Symbol.iterator]==="function"){if(e.length===t.length&&e.size===t.size){const n=e[Symbol.iterator](),i=t[Symbol.iterator]();while(true){const e=n.next(),t=i.next();if(e.done===t.done){if(!I(e.value,t.value))return false;if(e.done)return true}else return false}}else return false}else{const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return false;return i.every(n=>n in e&&I(e[n],t[n]))}}else return e===t}function k(e){if(typeof e==="object"){if(e===null)return null;if(Array.isArray(e))return e.map(k);if(e instanceof Set)return new Set([...e].map(k));if(e instanceof Map)return new Map(e.entries().map(([e,t])=>[k(e),k(t)]));return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,k(t)]))}else return e}function M(e){if(e.customMemo){return!e.customMemo()}else if(e.memo){const t=e.memo();const n=I(t,this.memo);this.memo=k(t);return n}else return false}function N(e,n,i){const o=t[e.dataset.componentId];if(M.call(o,n)){return}o.producer=n.render.bind(o);b.call(o,e,u(o.producer(),e.dataset.componentId,n.key,n.binding),i)}function T(e,n,i){const o=t[n];if(M.call(o,e)){return o.element}o.producer=e.render.bind(o);const s=o.producer();const l=r.call(o,u(s,n,e.key,e.binding),i,o.producer);o.element=l;return l}function A(e,n,i){const o=Array.from(e.children);const s=Array.isArray(n.children)?n.children:[n.children];const l=s.filter(e=>typeof e==="object");if(o.length>0&&l.length>0&&o.every(e=>"key"in e.dataset)&&l.every(e=>"key"in e)){const n={};for(let e=0;e<o.length;e++){n[o[e].dataset.key]=e}const s={};for(let e=0;e<l.length;e++){s[l[e].key]=e}const r=l.map(e=>n[e.key]??-1);const c=L(r.filter(e=>e>-1));for(let e=0;e<c.length;e++){const n=c[e];const r=o[n];const a=l[s[r.dataset.key]];if(d(a)){if("componentId"in r.dataset)N(r,a,i);else r.replaceWith(f(a,i))}else{if("componentId"in r.dataset)delete t[r.dataset.componentId];b.call(this,r,a,i)}}const u=new Set(c);const h={};for(let e=o.length-1;e>=0;e--){if(!u.has(e)){const n=o[e];if("componentId"in n.dataset){if(n.dataset.key in s){h[n.dataset.key]=n.dataset.componentId}else{delete t[n.dataset.componentId]}}n.remove()}}for(let t=0;t<l.length;t++){const n=l[t],o=e.children[t];if(!o){const t=h[n.key];if(t){e.appendChild(T(n,t,i))}else{e.appendChild(a.call(this,n,i))}}else{if(o.dataset.key!==n.key){const t=h[n.key];if(t){e.insertBefore(T(n,t,i),o)}else{e.insertBefore(a.call(this,n,i),o)}}}}}else if(l.length>0&&o.length>0){for(let e=0;e<Math.min(o.length,l.length);e++){let n=o[e],s=l[e];if(d(s)){if("componentId"in n.dataset)N(n,s,i);else n.replaceWith(f(s,i))}else{if("componentId"in n.dataset)delete t[n.dataset.componentId];b.call(this,n,s,i)}}if(o.length<l.length){for(let t=o.length;t<l.length;t++){let n=l[t];const o=a.call(this,n,i);e.appendChild(o)}}else if(o.length>l.length){for(let e=o.length-1;e>=l.length;e--){let n=o[e];if("componentId"in n.dataset)delete t[n.dataset.componentId];n.remove()}}}else if(l.length===0&&o.length>0){for(let e=o.length-1;e>=0;e--){let n=o[e];if("componentId"in n.dataset)delete t[n.dataset.componentId];n.remove()}}else if(l.length>0&&o.length===0){for(let t=0;t<l.length;t++){let n=l[t];const o=a.call(this,n,i);e.appendChild(o)}}for(let t=0;t<s.length;t++){if(t>=e.childNodes.length){e.appendChild(document.createTextNode(s[t]))}else{if(e.childNodes[t].nodeType===Node.TEXT_NODE){if(typeof s[t]!=="object"){e.childNodes[t].textContent=s[t]}else{while(e.childNodes[t].nodeType!==Node.ELEMENT_NODE){e.childNodes[t].remove()}}}else{if(typeof s[t]!=="object"){e.insertBefore(document.createTextNode(s[t]),e.childNodes[t])}}}}while(e.childNodes.length>s.length){e.lastChild.remove()}}function L(e){let t=e.length;let n=new Array(t).fill(0);let i=new Array(t+1).fill(0);i[0]=-1;let o=0;for(let s=0;s<t;s++){let t=1,l=o+1;while(t<l){let n=t+(l-t>>1);if(e[i[n]]>=e[s])l=n;else t=n+1}let r=t;n[s]=i[r-1];i[r]=s;if(r>o){o=r}}let s=new Array(o);let l=i[o];for(let t=o-1;t>=0;t--){s[t]=e[l];l=n[l]}return s}function v(e,t=false){const n=[];let i=a(e,n);if(typeof i==="string")i=document.createTextNode(i);return t?{element:i,onMounts:n}:i}function j(e,t){const{element:n,onMounts:i}=v(t,true);e.replaceWith(n);w(i)}function E(e,t){const{element:n,onMounts:i}=v(t,true);e.appendChild(n);w(i)}function H(e,t,n){const{element:i,onMounts:o}=v(n,true);e.insertBefore(i,t);w(o)}function w(e){e.forEach(e=>e())}export{v as create,j as replaceWith,E as appendChild,H as insertBefore,w as handleOnMounts};